<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>デイリーショップ集計</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{
  --bg:#0f1113;
  --panel:#131417;
  --muted:#7a7f86;
  --accent:#ff4b4b;
  --max-content-w:450px;
}
html,body{height:100%;margin:0;}
body{
  font-family:"Hiragino Kaku Gothic ProN","Segoe UI",Roboto,sans-serif;
  background:var(--bg);
  color:#fff;
  display:flex;
  justify-content:center;
  padding:18px 0;
}
.viewport{
  width:min(92vw,var(--max-content-w));
  margin:0 auto;
  box-sizing:border-box;
  padding:0 4vw;
}
.topbar{display:flex;gap:8px;margin-bottom:12px;}
input[type=text]{
  flex:1;
  padding:8px;
  border-radius:8px;
  border:1px solid #333;
  background:#1b1d20;
  color:#fff;
}
.btn{
  background:linear-gradient(180deg,#ffce00,#d4a000);
  border-radius:10px;
  padding:10px;
  font-weight:700;
  color:#111;
  border:0;
  box-shadow:0 4px #b38a00;
  cursor:pointer;
  transition:transform .08s,box-shadow .08s;
}
.btn:active{transform:translateY(3px);box-shadow:0 2px #b38a00;}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:12px;
  background:var(--panel);
  border-radius:10px;
  overflow:hidden;
}
th,td{
  padding:8px;
  text-align:center;
  border-bottom:1px solid #222;
}
th{background:#1b1d20;color:#ffce00;}
tr:last-child td{border-bottom:none;}
tr.total-row{background:#202226;font-weight:700;}
.loading{text-align:center;color:var(--muted);margin-top:10px;}
</style>
</head>
<body>
<div class="viewport">
  <div class="topbar">
    <input type="text" id="usernameInput" placeholder="ユーザー名で絞り込み (空欄＝全員)">
    <button class="btn" onclick="loadData()">集計する</button>
  </div>

  <div id="status" class="loading">読み込み待機中...</div>
  <table id="resultTable" style="display:none;">
    <thead>
      <tr><th>ItemName</th><th>Gold</th><th>Dia</th><th>Gold&Dia</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const supabaseUrl = "https://cxgbloauhimuhdjlvwvh.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN4Z2Jsb2F1aGltdWhkamx2d3ZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4NDQ1MDIsImV4cCI6MjA3NjQyMDUwMn0.wnRHKccWAba4wzC1XHqYPdzL0wF5uQOImbLkn4rs6SA";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

const itemOrder = [
  {name:"ユニット", src:"Unit"},
  {name:"鍵", src:"Key"},
  {name:"遺物", src:"Artifact"},
  {name:"招待状30枚", src:"Scroll_30"},
  {name:"招待状100枚", src:"Scroll_100"},
  {name:"招待状300枚", src:"Scroll_300"},
  {name:"神話石", src:"MythStone"},
  {name:"チュール", src:"Chur"},
  {name:"バッテリー", src:"Battery"},
  {name:"ペットフード", src:"PetFood"},
];

async function loadData(){
  const userFilter = document.getElementById("usernameInput").value.trim();
  const statusEl = document.getElementById("status");
  const table = document.getElementById("resultTable");
  const tbody = table.querySelector("tbody");
  tbody.innerHTML="";
  statusEl.textContent="集計中...";
  table.style.display="none";

  // Supabaseから logs テーブルの username, block_a を取得
  let query = supabase.from("logs").select("username, block_a");
  if(userFilter) query = query.eq("username", userFilter);
  const { data, error } = await query;

  if(error){ statusEl.textContent="データ取得エラー:"+error.message; return; }
  if(!data || data.length===0){ statusEl.textContent="該当データなし"; return; }

  const stats = {};
  for(const itemDef of itemOrder){
    stats[itemDef.src] = {gold:0, dia:0, both:0};
  }

  for(const row of data){
    let items = row.block_a;
    if(!items) continue;

    // JSON文字列で保存されている場合を考慮
    if(typeof items === "string"){
      try { items = JSON.parse(items); }
      catch(e){ console.warn("JSON parse error:", e); continue; }
    }

    // NoneItemブロック判定
    const allNone = Object.values(items).every(v=>v.src==="NoneItem");
    if(allNone) continue;

    let goldFlag=false, diaFlag=false;
    const localCount={};

    for(const key in items){
      const it = items[key];
      if(!it || it.src==="NoneItem") continue;
      if(!stats[it.src]) continue;

      const t = it.type;
      localCount[it.src] = localCount[it.src] || {gold:0, dia:0};
      if(t==="gold"){ localCount[it.src].gold++; goldFlag=true; }
      else if(t==="diamond"){ localCount[it.src].dia++; diaFlag=true; }
    }

    for(const src in localCount){
      if(localCount[src].gold>0) stats[src].gold += localCount[src].gold;
      if(localCount[src].dia>0) stats[src].dia += localCount[src].dia;
      if(goldFlag && diaFlag) stats[src].both++;
    }
  }

  let total={gold:0,dia:0,both:0};
  for(const itemDef of itemOrder){
    const s = stats[itemDef.src];
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${itemDef.name}</td><td>${s.gold}</td><td>${s.dia}</td><td>${s.both}</td>`;
    tbody.appendChild(tr);
    total.gold+=s.gold; total.dia+=s.dia; total.both+=s.both;
  }

  const totalRow=document.createElement("tr");
  totalRow.classList.add("total-row");
  totalRow.innerHTML=`<td>合計</td><td>${total.gold}</td><td>${total.dia}</td><td>${total.both}</td>`;
  tbody.appendChild(totalRow);

  statusEl.textContent="完了";
  table.style.display="table";
}
</script>
</body>
</html>
