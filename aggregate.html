<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pitchshift â€” Aggregated Stats</title>

<!-- Supabase client loaded at bottom script usage (v2) -->
<style>
:root{
  --bg:#0f1113;
  --panel:#131417;
  --muted:#7a7f86;
  --accent:#ffce00;
  --icon-size:28px;
  --max-w:450px;
  --gap:10px;
}

/* page layout */
html,body{height:100%;margin:0;}
body{
  font-family:"Hiragino Kaku Gothic ProN","Segoe UI",Roboto,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  background:var(--bg);
  color:#fff;
  display:flex;
  justify-content:center;
  padding:18px 0;
}
.viewport{
  width: min(96vw, var(--max-w));
  margin:0 auto;
  box-sizing:border-box;
  padding: 0 3vw;
}

/* controls: stacked, full width */
#usernameInput{
  width:100%;
  border-radius:10px;
  border:1px solid #444;
  background:#1a1c1f;
  color:#fff;
  padding:10px;
  font-size:14px;
  box-sizing:border-box;
  margin-bottom:8px;
}
#aggregateBtn{
  width:100%;
  background: linear-gradient(180deg,#ffce00,#d4a000);
  border-radius:10px;
  padding:10px;
  font-weight:700;
  color:#111;
  border:0;
  box-shadow:0 4px #b38a00;
  cursor:pointer;
  transition: transform .08s, box-shadow .08s;
}
#aggregateBtn:active{ transform: translateY(3px); box-shadow:0 2px #b38a00; }

/* panel & table */
.panel{
  background:var(--panel);
  padding:10px;
  border-radius:10px;
  margin-top:12px;
  box-sizing:border-box;
}
.loading { color:#aaa; margin-bottom:6px; font-size:13px; }
table{ width:100%; border-collapse:collapse; margin-top:8px; font-size:14px; }
th, td{ text-align:center; padding:8px; border-bottom:1px solid #333; vertical-align:middle; }
th{ color:var(--accent); background:#151617; }
td img{ width:var(--icon-size); height:var(--icon-size); object-fit:contain; display:block; margin:0 auto; }
.small { color:#ccc; font-size:12px; margin-left:6px; }
tfoot td{ font-weight:700; border-top:1px solid #555; }
.footer-note{ text-align:right; margin-top:8px; font-size:13px; color:#ccc; }

/* responsive tweaks */
@media (max-width:420px){
  :root{ --icon-size:26px; }
  .viewport{ padding: 0 3vw; }
}
@media (max-width:360px){
  :root{ --icon-size:24px; }
  .viewport{ padding: 0 3.5vw; }
}
</style>
</head>
<body>
  <div class="viewport">
    <input id="usernameInput" placeholder="Filter by username (leave blank for all)" autocomplete="off" />
    <button id="aggregateBtn">Aggregate</button>

    <div class="panel" role="region" aria-label="aggregation results">
      <div id="status" class="loading">Loading...</div>
      <table id="resultTable" style="display:none" aria-live="polite"></table>
      <div class="footer-note" id="blockCount"></div>
    </div>
  </div>

<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ----------------- REPLACE THESE WITH YOUR SUPABASE CREDENTIALS -----------------
   supabaseUrl: e.g. "https://xxxxxxxxxxxx.supabase.co"
   supabaseKey:  your anon/public anon key (keep private on server if writing from server)
   --------------------------------------------------------------------------- */
const supabaseUrl = "https://cxgbloauhimuhdjlvwvh.supabase.co"; // <-- replace
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN4Z2Jsb2F1aGltdWhkamx2d3ZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4NDQ1MDIsImV4cCI6MjA3NjQyMDUwMn0.wnRHKccWAba4wzC1XHqYPdzL0wF5uQOImbLkn4rs6SA";                    // <-- replace
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
/* --------------------------------------------------------------------------- */

/* items in order, using same images as pitchshiftLogFile */
const imgBase = "https://raw.githubusercontent.com/MenboLD/LD_Field/main/";
const items = [
  { key: "Unit", img: imgBase + "icon_01_unit.png" },
  { key: "Key", img: imgBase + "icon_02_free.png" },
  { key: "Artifact", img: imgBase + "icon_03_artifacts.png" },
  { key: "Scroll_30", img: imgBase + "icon_03_scroll_30.png" },
  { key: "Scroll_100", img: imgBase + "icon_04_scroll_100.png" },
  { key: "Scroll_300", img: imgBase + "icon_05_scroll_300.png" },
  { key: "Mythstone", img: imgBase + "icon_06_Mythstone.png" },
  { key: "Chur", img: imgBase + "icon_07_chur.png" },
  { key: "Battery", img: imgBase + "icon_08_pet_draw.png" },
  { key: "Petfood", img: imgBase + "icon_09_pet_upgrade.png" }
];

/* helper: percentage formatting (2 decimal, rounding) */
function fmtPct(count, denom){
  if(!denom || denom === 0) return "0.00%";
  return ( (count / denom * 100).toFixed(2) ) + "%";
}

/* parse JSON or object safely */
function parseMaybeJson(v){
  if(!v) return null;
  if(typeof v === "object") return v;
  if(typeof v === "string"){
    try { return JSON.parse(v); } catch(e) { return null; }
  }
  return null;
}

/* main aggregation function */
async function aggregate(){
  const username = document.getElementById("usernameInput").value.trim();
  const statusEl = document.getElementById("status");
  const table = document.getElementById("resultTable");
  const blockCountEl = document.getElementById("blockCount");

  statusEl.textContent = "Aggregating...";
  table.style.display = "none";
  table.innerHTML = "";
  blockCountEl.textContent = "";

  // Query logs table for block fields
  let query = supabase.from("logs").select("username, block_a, block_b, block_c, block_d, block_e, block_f");
  if(username) query = query.eq("username", username);
  const { data, error } = await query;

  if(error){
    statusEl.textContent = "Error: " + error.message;
    return;
  }
  if(!data || data.length === 0){
    statusEl.textContent = "No data found.";
    return;
  }

  // initialize counters
  const stats = {};
  items.forEach(it => stats[it.key] = { gold:0, dia:0 });
  let validBlocks = 0;

  // each row represents one submission; iterate block_a..block_f
  data.forEach(row => {
    const blockFields = ['block_a','block_b','block_c','block_d','block_e','block_f'];
    blockFields.forEach(field => {
      const raw = row[field];
      if(!raw) return;
      const parsed = parseMaybeJson(raw);
      if(!parsed) return;

      // parsed is object like { "1":{src,type}, "2":... }
      const slots = Object.values(parsed);
      if(!slots || slots.length === 0) return;

      // rule: if any slot is missing or src === "NoneItem" => block is invalid (skip)
      const hasNone = slots.some(s => !s || s.src === "NoneItem");
      if(hasNone) return;

      // valid block
      validBlocks++;

      // Counting rules:
      // - Unit: count each occurrence (multiple per block allowed)
      // - Non-unit: count at most once per block per type (gold/diamond)
      const seenNonUnitGold = new Set();
      const seenNonUnitDia  = new Set();

      slots.forEach(slot => {
        if(!slot || !slot.src) return;
        const src = slot.src;
        const type = slot.type;

        // Only consider known item keys
        if(!stats[src]) return;

        if(src === "Unit"){
          if(type === "gold") stats.Unit.gold++;
          else if(type === "diamond" || type === "dia") stats.Unit.dia++;
          return;
        }

        if(type === "gold"){
          if(!seenNonUnitGold.has(src)){
            stats[src].gold++;
            seenNonUnitGold.add(src);
          }
        } else if(type === "diamond" || type === "dia"){
          if(!seenNonUnitDia.has(src)){
            stats[src].dia++;
            seenNonUnitDia.add(src);
          }
        }
      });
    });
  });

  // percentage denominator is validBlocks * 5 (per request)
  const denom = validBlocks * 5;

  // build table HTML
  let html = "<thead><tr><th>Item</th><th>Gold</th><th>Dia</th><th>Gold&amp;Dia</th><th>%</th></tr></thead><tbody>";
  let totalGold = 0, totalDia = 0, totalBoth = 0;

  items.forEach(it => {
    const g = stats[it.key].gold;
    const d = stats[it.key].dia;
    const both = g + d;
    totalGold += g; totalDia += d; totalBoth += both;

    // spacing before parentheses
    const goldCell = `${g} <span class="small">(${fmtPct(g, denom)})</span>`;
    const diaCell  = `${d} <span class="small">(${fmtPct(d, denom)})</span>`;
    const bothCell = `${both}`;
    const pctCell  = fmtPct(both, denom);

    html += `<tr>
      <td><img src="${it.img}" alt="${it.key}"></td>
      <td>${goldCell}</td>
      <td>${diaCell}</td>
      <td>${bothCell}</td>
      <td>${pctCell}</td>
    </tr>`;
  });

  html += `</tbody><tfoot><tr><td>Total</td><td>${totalGold}</td><td>${totalDia}</td><td>${totalBoth}</td><td>-</td></tr></tfoot>`;

  table.innerHTML = html;
  table.style.display = "table";
  blockCountEl.textContent = `Total number of blocks: ${validBlocks}`;
  statusEl.textContent = "Completed.";
}

/* wire up */
document.getElementById("aggregateBtn").addEventListener("click", aggregate);

/* auto-run on load (aggregate all) */
window.addEventListener("DOMContentLoaded", () => {
  // small timeout so "Loading..." shows
  setTimeout(() => aggregate(), 60);
});
</script>
</body>
</html>
