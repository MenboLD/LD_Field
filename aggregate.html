<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Pitchshift Log Viewer</title>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f4f6f8;
      padding: 1rem;
      text-align: center;
    }
    h1 {
      margin-bottom: 1rem;
    }
    #username {
      margin-bottom: 0.5rem;
      padding: 6px;
      border-radius: 8px;
      border: 1px solid #ccc;
      width: 200px;
      text-align: center;
    }
    #fetchBtn {
      padding: 8px 16px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: #4c8bf5;
      color: #fff;
      margin-bottom: 12px;
    }
    table {
      margin: 0 auto;
      border-collapse: collapse;
      width: 90%;
      max-width: 600px;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    th, td {
      border-bottom: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f0f0f0;
    }
    tr:last-child td {
      font-weight: bold;
      background-color: #fafafa;
    }
  </style>
</head>
<body>
  <h1>Pitchshift Log Viewer</h1>
  <input type="text" id="username" placeholder="„É¶„Éº„Ç∂„ÉºÂêçÔºà‰ªªÊÑèÔºâ">
  <button id="fetchBtn">ÂÜçÈõÜË®à</button>

  <table id="resultTable">
    <thead>
      <tr>
        <th>ItemName</th>
        <th>Gold</th>
        <th>Dia</th>
        <th>Gold&Dia</th>
        <th>Âá∫ÁèæÁéá(%)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // üîß SupabaseË®≠ÂÆöÔºà„Åì„Åì„Çí„ÅÇ„Å™„Åü„ÅÆÂÄ§„Å´Êõ∏„ÅçÊèõ„Åà„ÇãÔºâ
    const supabaseUrl = "https://cxgbloauhimuhdjlvwvh.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN4Z2Jsb2F1aGltdWhkamx2d3ZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4NDQ1MDIsImV4cCI6MjA3NjQyMDUwMn0.wnRHKccWAba4wzC1XHqYPdzL0wF5uQOImbLkn4rs6SA";
    const supabase = createClient(supabaseUrl, supabaseKey);

    const ITEM_LIST = [
      "Unit", "Key", "Artifact", "Scroll_30",
      "Scroll_100", "Scroll_300", "Mythstone",
      "Chur", "Battery", "Petfood"
    ];

    const tbody = document.querySelector("#resultTable tbody");
    const fetchBtn = document.getElementById("fetchBtn");
    const usernameInput = document.getElementById("username");

    async function loadData(username = "") {
      tbody.innerHTML = "<tr><td colspan='5'>Ë™≠„ÅøËæº„Åø‰∏≠...</td></tr>";

      let query = supabase.from("pitchshiftLogFile").select("username, items");
      if (username.trim()) query = query.eq("username", username.trim());

      const { data, error } = await query;
      if (error) {
        tbody.innerHTML = `<tr><td colspan="5">„Ç®„É©„Éº: ${error.message}</td></tr>`;
        return;
      }
      if (!data || data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5">Ë©≤ÂΩì„Éá„Éº„Çø„Å™„Åó</td></tr>`;
        return;
      }

      const count = {};
      ITEM_LIST.forEach(n => count[n] = { gold: 0, dia: 0 });

      for (const row of data) {
        let items = row.items;
        if (typeof items === "string") {
          try { items = JSON.parse(items); } catch { continue; }
        }
        if (!items || typeof items !== "object") continue;

        const values = Object.values(items);
        if (values.some(v => !v || v.src === "NoneItem")) continue;

        for (const i of values) {
          if (!i || !i.src) continue;
          const name = ITEM_LIST.find(n => n === i.src);
          if (!name) continue;

          // „Ç´„Ç¶„É≥„Éà„É´„Éº„É´
          if (i.type === "gold") count[name].gold++;
          else if (i.type === "diamond") count[name].dia++;
        }
      }

      const totalGold = Object.values(count).reduce((a, b) => a + b.gold, 0);
      const totalDia = Object.values(count).reduce((a, b) => a + b.dia, 0);
      const totalAll = totalGold + totalDia;

      tbody.innerHTML = "";
      ITEM_LIST.forEach(name => {
        const gold = count[name].gold;
        const dia = count[name].dia;
        const both = gold + dia;
        const rate = totalAll > 0 ? ((both / totalAll) * 100).toFixed(2) : "0.00";
        tbody.innerHTML += `
          <tr>
            <td>${name}</td>
            <td>${gold}</td>
            <td>${dia}</td>
            <td>${both}</td>
            <td>${rate}</td>
          </tr>
        `;
      });
      tbody.innerHTML += `
        <tr>
          <td>ÂêàË®à</td>
          <td>${totalGold}</td>
          <td>${totalDia}</td>
          <td>${totalAll}</td>
          <td>100.00</td>
        </tr>
      `;
    }

    fetchBtn.addEventLi
