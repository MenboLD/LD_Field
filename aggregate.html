<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Lucky Defense - Aggregated Data</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root { --bg:#0f1113; --panel:#131417; --accent:#ffce00; --icon-size:28px; }
body { font-family:"Segoe UI",Roboto,sans-serif; background:var(--bg); color:#fff; display:flex; justify-content:center; padding:18px 0; }
.viewport { width:min(92vw,450px); margin:0 auto; box-sizing:border-box; padding:0 4vw; }
input { width:100%; border-radius:10px; border:1px solid #444; background:#1a1c1f; color:#fff; padding:10px; font-size:14px; box-sizing:border-box; margin-bottom:8px; }
button { width:100%; background:linear-gradient(180deg,#ffce00,#d4a000); border-radius:10px; padding:10px; font-weight:700; color:#111; border:0; box-shadow:0 4px #b38a00; cursor:pointer; transition: transform .08s, box-shadow .08s; }
button:active { transform:translateY(3px); box-shadow:0 2px #b38a00; }
.panel { background:var(--panel); padding:10px; border-radius:10px; }
table { width:100%; border-collapse:collapse; margin-top:8px; font-size:14px; }
th, td { text-align:center; padding:8px; border-bottom:1px solid #333; }
th { color:var(--accent); background:#151617; }
td img { width:var(--icon-size); height:var(--icon-size); object-fit:contain; display:block; margin:0 auto; }
tfoot td { font-weight:bold; border-top:1px solid #555; }
.footer-note { text-align:right; margin-top:8px; font-size:13px; color:#ccc; }
.loading { color:#aaa; margin:6px 0; }
.small { color:#ccc; font-size:13px; }
</style>
</head>
<body>
<div class="viewport">
  <input id="usernameInput" placeholder="Filter by username (leave blank for all)">
  <button onclick="aggregate()">Aggregate</button>
  <div class="panel">
    <div id="status" class="loading">Loading...</div>
    <table id="resultTable" style="display:none;"></table>
    <div class="footer-note" id="blockCount"></div>
  </div>
</div>

<script>
const supabaseUrl = "https://cxgbloauhimuhdjlvwvh.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN4Z2Jsb2F1aGltdWhkamx2d3ZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4NDQ1MDIsImV4cCI6MjA3NjQyMDUwMn0.wnRHKccWAba4wzC1XHqYPdzL0wF5uQOImbLkn4rs6SA";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

const imgBase = "https://raw.githubusercontent.com/MenboLD/LD_Field/main/";
const items = [
  { key: "Unit", img: imgBase + "icon_01_unit.png" },
  { key: "Key", img: imgBase + "icon_02_free.png" },
  { key: "Artifact", img: imgBase + "icon_03_artifacts.png" },
  { key: "Scroll_30", img: imgBase + "icon_03_scroll_30.png" },
  { key: "Scroll_100", img: imgBase + "icon_04_scroll_100.png" },
  { key: "Scroll_300", img: imgBase + "icon_05_scroll_300.png" },
  { key: "Mythstone", img: imgBase + "icon_06_Mythstone.png" },
  { key: "Chur", img: imgBase + "icon_07_chur.png" },
  { key: "Battery", img: imgBase + "icon_08_pet_draw.png" },
  { key: "Petfood", img: imgBase + "icon_09_pet_upgrade.png" }
];

const ITEM_NAME_MAP_REVERSE = {
  "Unit": "Unit",
  "Free": "Key",
  "Artifact": "Artifact",
  "Scroll_30": "Scroll_30",
  "Scroll_100": "Scroll_100",
  "Scroll_300": "Scroll_300",
  "Mythstone": "Mythstone",
  "Chur": "Chur",
  "PetDraw": "Battery",
  "PetUpgrade": "Petfood"
};

function parseMaybeJson(v){
  if(!v) return null;
  if(typeof v==="object") return v;
  try { return JSON.parse(v); } catch { return null; }
}

// 判定: 同じアイテム・同じ価格で重複か
function isDuplicate(slot, counted) {
  const key = slot.src + '_' + slot.type;
  return counted[key] ? true : false;
}

async function aggregate(){
  const username = document.getElementById("usernameInput").value.trim();
  const statusEl = document.getElementById("status");
  const table = document.getElementById("resultTable");
  const blockCountEl = document.getElementById("blockCount");

  statusEl.textContent = "Aggregating...";
  table.style.display = "none";
  table.innerHTML = "";
  blockCountEl.textContent = "";

  let query = supabase.from("logs").select("username, block_a, block_b, block_c, block_d, block_e, block_f");
  if(username) query = query.eq("username", username);
  const { data, error } = await query;
  if(error){ statusEl.textContent = "Error: " + error.message; return; }
  if(!data || data.length===0){ statusEl.textContent="No data found."; return; }

  const stats = {};
  items.forEach(it => stats[it.key] = { gold: 0, dia: 0 });
  let validBlocks = 0;
  let totalItemCount = 0;

  for(const row of data){
    const blockFields = ['block_a','block_b','block_c','block_d','block_e','block_f'];
    for(const field of blockFields){
      const parsed = parseMaybeJson(row[field]);
      if(!parsed) continue;

      const block = Object.values(parsed);
      if(block.length !== 5) continue;

      // まず重複判定
      const counted = {};
      const duplicateCheck = {};
      let blockInvalid = false;

      for(const slot of block){
        if(!slot || !slot.src || ["noitem","nll","NoneItem"].includes(slot.src)) continue;
        const src = ITEM_NAME_MAP_REVERSE[slot.src] || slot.src;
        if(src==="Unit") continue;

        const keyPrice = src + '_' + slot.type;
        duplicateCheck[keyPrice] = (duplicateCheck[keyPrice] || 0) + 1;
      }

      // 緩和条件: 価格関係なく2個だけ同じアイテムがある場合
      const blockSlots = {};
      for(const slot of block){
        if(!slot || !slot.src || ["noitem","nll","NoneItem"].includes(slot.src)) continue;
        const src = ITEM_NAME_MAP_REVERSE[slot.src] || slot.src;
        if(src==="Unit") continue;

        blockSlots[src] = (blockSlots[src] || []).concat(slot.type);
      }

      for(const [item, types] of Object.entries(blockSlots)){
        // 2個だけのアイテムであれば1つの価格を変更
        if(types.length===2){
          if(types[0]===types[1]){
            // 同じ価格種類なら片方を緩和
            types[1] = types[1]==="gold"?"diamond":"gold";
          }
        }
      }

      // 再判定: 同じアイテム・同じ価格が2個以上ある場合は無効ブロック
      for(const [item, types] of Object.entries(blockSlots)){
        const counter = {};
        types.forEach(t => counter[t] = (counter[t]||0)+1);
        for(const t of Object.values(counter)){
          if(t>1) blockInvalid=true;
        }
      }
      if(blockInvalid) continue; // 無効ブロックはスキップ
      validBlocks++;

      // 集計
      for(const slot of block){
        if(!slot || !slot.src || ["noitem","nll","NoneItem"].includes(slot.src)) continue;
        const src = ITEM_NAME_MAP_REVERSE[slot.src] || slot.src;
        const type = slot.type;
        if(!stats[src]) continue;

        if(src==="Unit"){
          if(type==="gold") stats[src].gold++;
          else if(type==="diamond" || type==="dia") stats[src].dia++;
          totalItemCount++;
        } else {
          // 重複チェック済み
          const countedKey = src+'_'+type;
          if(!counted[countedKey]){
            if(type==="gold") stats[src].gold++;
            else if(type==="diamond" || type==="dia") stats[src].dia++;
            totalItemCount++;
            counted[countedKey]=true;
          }
        }
      }
    }
  }

  let html = "<thead><tr><th>Item</th><th>Gold</th><th>Dia</th><th>Gold&Dia</th><th>%</th></tr></thead><tbody>";
  let totalGold = 0, totalDia = 0, totalBoth = 0;

  for(const it of items){
    const g = stats[it.key].gold;
    const d = stats[it.key].dia;
    const both = g + d;
    totalGold += g;
    totalDia += d;
    totalBoth += both;

    html += `<tr>
      <td><img src="${it.img}" alt="${it.key}"></td>
      <td>${g} <span class='small'>(${totalItemCount ? (g/totalItemCount*100).toFixed(2) : '0.00'}%)</span></td>
      <td>${d} <span class='small'>(${totalItemCount ? (d/totalItemCount*100).toFixed(2) : '0.00'}%)</span></td>
      <td>${both}</td>
      <td>${totalItemCount ? (both/totalItemCount*100).toFixed(2) : '0.00'}%</td>
    </tr>`;
  }

  html += `<tfoot><tr><td>Total</td><td>${totalGold}</td><td>${totalDia}</td><td>${totalBoth}</td><td>100%</td></tr></tfoot>`;
  table.innerHTML = html;
  table.style.display = "table";
  blockCountEl.textContent = `Total number of full blocks: ${validBlocks}`;
  statusEl.textContent = "Completed.";
}

window.addEventListener("DOMContentLoaded", ()=>aggregate());
</script>
</body>
</html>

