<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>アイテム出現率集計</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #eee; }
  </style>
</head>
<body>
  <h1>アイテム出現率集計</h1>
  <p>ページを再読込すると最新の集計が反映されます。</p>

  <table id="resultTable">
    <thead>
      <tr>
        <th>ItemName</th>
        <th>Gold</th>
        <th>Dia</th>
        <th>Gold&Dia</th>
        <th>出現率(%)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    // 🔧 Supabase設定（ここをあなたの値に変更）
    const supabaseUrl = "https://cxgbloauhimuhdjlvwvh.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN4Z2Jsb2F1aGltdWhkamx2d3ZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4NDQ1MDIsImV4cCI6MjA3NjQyMDUwMn0.wnRHKccWAba4wzC1XHqYPdzL0wF5uQOImbLkn4rs6SA";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    const ITEM_LIST = [
      "Unit", "Key", "Artifact", "Scroll_30",
      "Scroll_100", "Scroll_300", "Mythstone",
      "Chur", "Battery", "Petfood"
    ];

    async function loadData() {
      const { data, error } = await supabase.from("pitchshiftLogFile").select("items");
      if (error) {
        console.error(error);
        return;
      }

      const count = {};
      ITEM_LIST.forEach(name => count[name] = { gold: 0, dia: 0 });

      for (const row of data) {
        let items = row.items;

        // JSON文字列のままならパース
        if (typeof items === "string") {
          try { items = JSON.parse(items); } catch { continue; }
        }
        if (!items || typeof items !== "object") continue;

        // NoneItemを含むブロックは除外
        const values = Object.values(items);
        if (values.some(i => i.src === "NoneItem")) continue;

        // 5スロット分を走査
        for (const i of values) {
          if (!i || !i.src) continue;
          const name = ITEM_LIST.find(n => i.src === n);
          if (!name) continue;

          if (i.type === "gold") count[name].gold++;
          else if (i.type === "diamond") count[name].dia++;
        }
      }

      const totalGold = Object.values(count).reduce((a, b) => a + b.gold, 0);
      const totalDia = Object.values(count).reduce((a, b) => a + b.dia, 0);
      const totalAll = totalGold + totalDia;

      const tbody = document.querySelector("#resultTable tbody");
      tbody.innerHTML = "";

      ITEM_LIST.forEach(name => {
        const gold = count[name].gold;
        const dia = count[name].dia;
        const both = gold + dia;
        const rate = totalAll > 0 ? ((both / totalAll) * 100).toFixed(2) : "0.00";
        tbody.innerHTML += `<tr>
          <td>${name}</td><td>${gold}</td><td>${dia}</td><td>${both}</td><td>${rate}</td>
        </tr>`;
      });

      tbody.innerHTML += `<tr style="font-weight:bold;">
        <td>合計</td><td>${totalGold}</td><td>${totalDia}</td><td>${totalAll}</td><td>100.00</td>
      </tr>`;
    }

    loadData();
  </script>
</body>
</html>
