<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Lucky Defense - Aggregated Data</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --bg: #0f1113;
  --panel: #131417;
  --accent: #ffce00;
  --icon-size: 28px;
}
body {
  font-family: "Segoe UI", Roboto, sans-serif;
  background: var(--bg);
  color: #fff;
  display: flex;
  justify-content: center;
  padding: 18px 0;
}
.viewport {
  width: min(92vw, 450px);
  margin: 0 auto;
  box-sizing: border-box;
  padding: 0 4vw;
}
input {
  width: 100%;
  border-radius: 10px;
  border: 1px solid #444;
  background: #1a1c1f;
  color: #fff;
  padding: 10px;
  font-size: 14px;
  box-sizing: border-box;
  margin-bottom: 8px;
}
button {
  width: 100%;
  background: linear-gradient(180deg, #ffce00, #d4a000);
  border-radius: 10px;
  padding: 10px;
  font-weight: 700;
  color: #111;
  border: 0;
  box-shadow: 0 4px #b38a00;
  cursor: pointer;
  transition: transform 0.08s, box-shadow 0.08s;
}
button:active {
  transform: translateY(3px);
  box-shadow: 0 2px #b38a00;
}
.panel {
  background: var(--panel);
  padding: 10px;
  border-radius: 10px;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 8px;
  font-size: 14px;
}
th, td {
  text-align: center;
  padding: 8px;
  border-bottom: 1px solid #333;
}
th {
  color: var(--accent);
  background: #151617;
}
td img {
  width: var(--icon-size);
  height: var(--icon-size);
  object-fit: contain;
  display: block;
  margin: 0 auto;
}
tfoot td {
  font-weight: bold;
  border-top: 1px solid #555;
}
.footer-note {
  text-align: right;
  margin-top: 8px;
  font-size: 13px;
  color: #ccc;
}
.loading { color: #aaa; margin: 6px 0; }
.small { color: #ccc; font-size: 13px; }
</style>
</head>
<body>
<div class="viewport">
  <input id="usernameInput" placeholder="Filter by username (leave blank for all)">
  <button onclick="aggregate()">Aggregate</button>
  <div class="panel">
    <div id="status" class="loading">Loading...</div>
    <table id="resultTable" style="display:none;"></table>
    <div class="footer-note" id="blockCount"></div>
  </div>
</div>

<script>
/* Supabase config */
const supabaseUrl = "https://cxgbloauhimuhdjlvwvh.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN4Z2Jsb2F1aGltdWhkamx2d3ZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4NDQ1MDIsImV4cCI6MjA3NjQyMDUwMn0.wnRHKccWAba4wzC1XHqYPdzL0wF5uQOImbLkn4rs6SA";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

/* Item icons and keys */
const imgBase = "https://raw.githubusercontent.com/MenboLD/LD_Field/main/";
const items = [
  { key: "Unit", img: imgBase + "icon_01_unit.png" },
  { key: "Key", img: imgBase + "icon_02_free.png" },
  { key: "Artifact", img: imgBase + "icon_03_artifacts.png" },
  { key: "Scroll_30", img: imgBase + "icon_03_scroll_30.png" },
  { key: "Scroll_100", img: imgBase + "icon_04_scroll_100.png" },
  { key: "Scroll_300", img: imgBase + "icon_05_scroll_300.png" },
  { key: "Mythstone", img: imgBase + "icon_06_Mythstone.png" },
  { key: "Chur", img: imgBase + "icon_07_chur.png" },
  { key: "Battery", img: imgBase + "icon_08_pet_draw.png" },
  { key: "Petfood", img: imgBase + "icon_09_pet_upgrade.png" }
];

/* helper to convert src filename to key */
function srcToKey(src) {
  switch(src) {
    case "icon_01_unit.png": return "Unit";
    case "icon_02_free.png": return "Key";
    case "icon_03_artifacts.png": return "Artifact";
    case "icon_03_scroll_30.png": return "Scroll_30";
    case "icon_04_scroll_100.png": return "Scroll_100";
    case "icon_05_scroll_300.png": return "Scroll_300";
    case "icon_06_Mythstone.png": return "Mythstone";
    case "icon_07_chur.png": return "Chur";
    case "icon_08_pet_draw.png": return "Battery";
    case "icon_09_pet_upgrade.png": return "Petfood";
    default: return null;
  }
}

function parseMaybeJson(v) {
  if (!v) return null;
  if (typeof v === "object") return v;
  if (typeof v === "string") {
    try { return JSON.parse(v); } catch { return null; }
  }
  return null;
}

async function aggregate() {
  const username = document.getElementById("usernameInput").value.trim();
  const statusEl = document.getElementById("status");
  const table = document.getElementById("resultTable");
  const blockCountEl = document.getElementById("blockCount");

  statusEl.textContent = "Aggregating...";
  table.style.display = "none";
  table.innerHTML = "";
  blockCountEl.textContent = "";

  let query = supabase.from("logs").select("username, block_a, block_b, block_c, block_d, block_e, block_f");
  if (username) query = query.eq("username", username);
  const { data, error } = await query;

  if (error) {
    statusEl.textContent = "Error: " + error.message;
    return;
  }
  if (!data || data.length === 0) {
    statusEl.textContent = "No data found.";
    return;
  }

  // initialize stats
  const stats = {};
  items.forEach(it => stats[it.key] = { gold: 0, dia: 0 });
  let validBlocks = 0;
  let totalItemCount = 0; // NoneItemを除いた総アイテム数

  data.forEach(row => {
    const blockFields = ['block_a','block_b','block_c','block_d','block_e','block_f'];
    blockFields.forEach(field => {
      const parsed = parseMaybeJson(row[field]);
      if (!parsed) return;

      const values = Object.values(parsed);
      if (values.length < 5) return; // 5スロット未満は除外
      const hasNoneItem = values.some(v => !v || v.src === "NoneItem");
      if (hasNoneItem) return; // NoneItem が1つでもあれば除外

      validBlocks++;

      const seenGold = new Set();
      const seenDia = new Set();

      values.forEach(slot => {
        if (!slot || slot.src === "NoneItem") return;

        const filename = slot.src.split("/").pop();
        const key = srcToKey(filename);
        if (!key) return;

        totalItemCount++; // NoneItem以外の総数カウント

        if (slot.type === "gold" && !seenGold.has(key)) {
          stats[key].gold++;
          seenGold.add(key);
        }
        if ((slot.type === "diamond" || slot.type === "dia") && !seenDia.has(key)) {
          stats[key].dia++;
          seenDia.add(key);
        }
      });
    });
  });

  // build table
  let html = "<thead><tr><th>Item</th><th>Gold</th><th>Dia</th><th>Gold&Dia</th><th>%</th></tr></thead><tbody>";
  items.forEach(it => {
    const g = stats[it.key].gold;
    const d = stats[it.key].dia;
    const both = g + d;

    const goldCell = `${g} <span class='small'>(${(g / totalItemCount * 100).toFixed(2)}%)</span>`;
    const diaCell  = `${d} <span class='small'>(${(d / totalItemCount * 100).toFixed(2)}%)</span>`;
    const bothCell = `${both}`;
    const pctCell  = ((both / totalItemCount * 100).toFixed(2)) + "%";

    html += `<tr>
      <td><img src="${it.img}" alt="${it.key}"></td>
      <td>${goldCell}</td>
      <td>${diaCell}</td>
      <td>${bothCell}</td>
      <td>${pctCell}</td>
    </tr>`;
  });

  const totalGold = items.reduce((sum,it)=>sum+stats[it.key].gold,0);
  const totalDia  = items.reduce((sum,it)=>sum+stats[it.key].dia,0);
  const totalBoth = totalGold + totalDia;

  html += `<tfoot><tr><td>Total</td><td>${totalGold}</td><td>${totalDia}</td><td>${totalBoth}</td><td>100%</td></tr></tfoot>`;
  table.innerHTML = html;
  table.style.display = "table";
  blockCountEl.textContent = `Total number of blocks: ${validBlocks}`;
  statusEl.textContent = "Completed.";
}

/* ページ読み込み時に自動実行 */
window.addEventListener("DOMContentLoaded", () => aggregate());
</script>
</body>
</html>
