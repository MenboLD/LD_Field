<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>LD_DailyShop</title>
<style>
/* （省略：既存のCSSはそのまま） */
</style>
</head>
<body>
<div class="viewport">
  <div class="topbar">
    <input id="username" type="text" placeholder="Enter user name (optional)">
    <button id="sendBtn" class="btn">SEND</button>
    <button id="resetBtn" class="btn secondary">All Reset</button>
  </div>

  <div class="blocks" id="blocksContainer"></div>

  <div class="products">
    <div class="price-frame gold-frame" id="goldFrame"></div>
    <div class="price-frame dia-frame" id="diaFrame"></div>
  </div>

  <div class="legend">
    <div style="display:flex;align-items:center;gap:8px">
      <div class="box gold"><img src="https://raw.githubusercontent.com/MenboLD/LD_Field/main/icon_00_type_gold.png" alt="gold"></div>
      <div>… Gold</div>
    </div>
    <div style="display:flex;align-items:center;gap:8px">
      <div class="box diamond"><img src="https://raw.githubusercontent.com/MenboLD/LD_Field/main/icon_00_type_dia.png" alt="diamond"></div>
      <div>… Diamond</div>
    </div>
  </div>

  <div class="hint">
    Select below → place into the highlighted cell above.<br>
    When you enter your username, you can later view only your data in the aggregate results.<br>
    <a href="https://menbold.github.io/LD_Field/aggregate.html" target="_blank" style="color:#4cc9ff;text-decoration:none;font-weight:bold;">View aggregate results</a>
  </div>

  <div class="footer-img">
    <img src="https://menbold.github.io/LD_Field/madeinme.png" alt="made by me">
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* blocks initialization */
const blocks = ['A','B','C','D','E','F'];
const slots = {};
const history = {};
const nextIndex = {};
let currentBlock = 'A';

blocks.forEach(b=>{
  slots[b] = [null,null,null,null,null,null,null];
  history[b] = [];
  nextIndex[b] = 2;
});

/* create block elements */
const blockContainer = document.getElementById('blocksContainer');
blocks.forEach(b=>{
  const block = document.createElement('div');
  block.className = 'block';
  block.dataset.block = b;
  block.innerHTML = `<div class="label">${b}</div>
    <div class="cell undo-cell" data-pos="1" data-block="${b}" title="UNDO" onclick="undoBlock('${b}')">
      <img src="https://raw.githubusercontent.com/MenboLD/LD_Field/main/icon_UNDO.png" alt="undo">
    </div>` + Array.from({length:5},(_,i)=>`<div class="cell" data-pos="${i+2}" data-block="${b}" onclick="focusCell(event)"></div>`).join('');
  blockContainer.appendChild(block);
});

/* products */
const items=[
  "icon_01_unit.png","icon_02_free.png","icon_03_artifacts.png",
  "icon_03_scroll_30.png","icon_04_scroll_100.png","icon_05_scroll_300.png",
  "icon_06_Mythstone.png","icon_07_chur.png","icon_08_pet_draw.png","icon_09_pet_upgrade.png"
];
function buildProducts(frameId,type){
  const frame=document.getElementById(frameId);
  items.forEach((it,i)=>{
    if(type==='gold' && i>=6) return;
    const div=document.createElement('div');
    div.className='prod-item';
    div.dataset.src=`https://raw.githubusercontent.com/MenboLD/LD_Field/main/${it}`;
    div.dataset.type=type;
    div.onclick=placeProduct;
    div.innerHTML=`<img src="https://raw.githubusercontent.com/MenboLD/LD_Field/main/${it}" alt="">`;
    frame.appendChild(div);
  });
}
buildProducts('goldFrame','gold');
buildProducts('diaFrame','diamond');

/* helper functions */
function cellEl(block,pos){ return document.querySelector(`.cell[data-block="${block}"][data-pos="${pos}"]`); }
function getNextBlock(block){ const i=blocks.indexOf(block); return blocks[(i+1)%blocks.length]; }
function refreshEditingHighlight(block){
  document.querySelectorAll('.cell').forEach(c=>c.classList.remove('editing'));
  const idx=nextIndex[block];
  if(idx>=2&&idx<=6){ const el=cellEl(block,idx); if(el) el.classList.add('editing'); }
  currentBlock=block;
}
function focusCell(e){
  const el=e.currentTarget; const b=el.dataset.block; const pos=+el.dataset.pos;
  if(pos>=2&&pos<=6) nextIndex[b]=pos; refreshEditingHighlight(b);
}
function placeProduct(e){
  const item=e.currentTarget;
  const src=item.dataset.src; const type=item.dataset.type;
  const b=currentBlock; const idx=nextIndex[b]; if(!(idx>=2&&idx<=6))return;
  slots[b][idx]={src,type}; history[b].push(idx);
  const t=cellEl(b,idx); if(t){t.innerHTML=`<img src="${src}" alt="">`;t.setAttribute('data-type',type);}
  let ni=idx+1; while(ni<=6&&slots[b][ni])ni++;
  if(ni<=6){nextIndex[b]=ni;refreshEditingHighlight(b);}else{nextIndex[getNextBlock(b)]=2;refreshEditingHighlight(getNextBlock(b));}
}
function undoBlock(b){
  const last=history[b].pop(); if(!last)return;
  slots[b][last]=null; const t=cellEl(b,last); if(t){t.innerHTML='';t.removeAttribute('data-type');}
  nextIndex[b]=last; refreshEditingHighlight(b);
}

/* reset */
document.getElementById('resetBtn').addEventListener('click',()=>{
  blocks.forEach(b=>{
    history[b]=[];
    for(let i=2;i<=6;i++){ slots[b][i]=null; const t=cellEl(b,i); if(t){t.innerHTML='';t.removeAttribute('data-type');} }
    nextIndex[b]=2;
    document.querySelector(`.block[data-block="${b}"]`).classList.remove('highlight');
  });
  currentBlock='A'; refreshEditingHighlight('A');
});

/* normalize src to match aggregate.html expectation */
function normalizeSrc(src){
  if(!src) return "";
  const name = src.split("/").pop().replace(".png","");
  if(name.includes("unit")) return "Unit";
  if(name.includes("artifacts")) return "Artifact";
  if(name.includes("scroll_30")) return "Scroll_30";
  if(name.includes("scroll_100")) return "Scroll_100";
  if(name.includes("scroll_300")) return "Scroll_300";
  if(name.includes("Mythstone")) return "Mythstone";
  if(name.includes("chur")) return "Chur";
  if(name.includes("pet_draw")) return "Petfood";
  if(name.includes("pet_upgrade")) return "Battery";
  if(name.includes("free")) return "Key";
  return "Unknown";
}

/* send animation + filter filled blocks only */
document.getElementById('sendBtn').addEventListener('click',async ()=>{
  const btn=document.getElementById('sendBtn');
  btn.animate([{transform:'scale(1)'},{transform:'scale(0.95)'},{transform:'scale(1)'}],{duration:180});

  const name=document.getElementById('username').value.trim()||"NoneName";
  const payload={username:name};

  blocks.forEach(b=>{
    const blockEl=document.querySelector(`.block[data-block="${b}"]`);
    const itemsInBlock=slots[b].slice(2,7);
    const hasNone=itemsInBlock.some(x=>!x);
    if(itemsInBlock.length===5 && !hasNone){
      blockEl.classList.add('highlight'); // highlight
      const blockData={};
      itemsInBlock.forEach((s,i)=>{
        blockData[i+1]={src:normalizeSrc(s.src),type:s.type};
      });
      payload[`block_${b.toLowerCase()}`]=blockData;
    } else {
      blockEl.classList.remove('highlight');
    }
  });

  if(Object.keys(payload).length>1){
    const {error}=await supabase.from("logs").insert([payload]);
    if(error) alert("Error: "+error.message); else alert("Upload completed!");
  } else {
    alert("No fully filled blocks to send.");
  }

  document.getElementById('resetBtn').click();
});

/* highlight first */
document.addEventListener('DOMContentLoaded',()=>{currentBlock='A';nextIndex['A']=2;refreshEditingHighlight('A');});

/* Supabase setup */
const SUPABASE_URL="https://cxgbloauhimuhdjlvwvh.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN4Z2Jsb2F1aGltdWhkamx2d3ZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4NDQ1MDIsImV4cCI6MjA3NjQyMDUwMn0.wnRHKccWAba4wzC1XHqYPdzL0wF5uQOImbLkn4rs6SA";
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
</script>
</body>
</html>
