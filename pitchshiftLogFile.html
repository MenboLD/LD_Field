<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>LD_DailyShop</title>
<style>
:root{
  --bg:#0f1113;
  --panel:#131417;
  --muted:#7a7f86;
  --accent:#ff4b4b;
  --cell-size:44px;
  --prod-size:56px;
  --block-gap:10px;
  --grid-gap:6px;
  --max-content-w:450px;
}
html,body{height:100%;margin:0;}
body{
  font-family:"Hiragino Kaku Gothic ProN","Segoe UI",Roboto,sans-serif;
  background:var(--bg);
  color:#fff;
  display:flex;
  justify-content:center;
  padding:18px 0;
}
.viewport{
  width: min(92vw, var(--max-content-w));
  margin: 0 auto;
  box-sizing: border-box;
  padding: 0 4vw;
}
.topbar { display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap; }
.topbar input {
  width:100%;
  padding:8px;
  border-radius:8px;
  border:1px solid #ccc;
  text-align:center;
}
.btn { flex:1; background: linear-gradient(180deg,#ffce00,#d4a000); border-radius:10px; padding:10px; font-weight:700; color:#111; border:0; box-shadow:0 4px #b38a00; cursor:pointer; transition: transform .08s, box-shadow .08s; }
.btn:active { transform: translateY(3px); box-shadow:0 2px #b38a00; }
.btn.secondary { background: linear-gradient(180deg,#00b4ff,#0072d4); color:#fff; box-shadow:0 4px #005ea8; }

/* blocks */
.blocks { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--block-gap); margin-bottom:12px; align-items: start; }
.block {
  background:var(--panel);
  padding:8px;
  border-radius:10px;
  position:relative;
  display:grid;
  grid-template-columns: repeat(3, var(--cell-size));
  grid-template-rows: repeat(2, var(--cell-size));
  gap: var(--grid-gap);
  justify-content:center;
}
.block .label { position:absolute; top:6px; left:8px; font-size:12px; color:var(--muted); }

.cell {
  width:var(--cell-size);
  height:var(--cell-size);
  border-radius:6px;
  background:#222;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  overflow:hidden;
  box-sizing:border-box;
  transition: box-shadow .08s, outline .08s, background .08s;
}
.cell img{ max-width:100%; max-height:100%; display:block; pointer-events:none; }

.cell.editing {
  outline: 3px solid var(--accent);
  outline-offset: -3px;
  background: #222;
}

.undo-cell { background:transparent; cursor:pointer; padding:2px; }
.undo-cell img{ width:100%; height:100%; object-fit:contain; }

.products { display:flex; flex-direction:column; gap:10px; margin-bottom:12px; }
.price-frame { border-radius:10px; padding:8px; display: grid; grid-template-columns: repeat(6, 1fr); gap:8px; align-items:center; width:100%; box-sizing:border-box; overflow:visible; }
.gold-frame { border:2px solid gold; background: rgba(255,215,0,0.06); padding:8px; }
.dia-frame  { border:2px solid deepskyblue; background: rgba(0,191,255,0.06); padding:8px; }

.prod-item {
  width: 100%;
  aspect-ratio: 1 / 1;
  border-radius:8px;
  background:#1b1d20;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  transition: transform .06s;
  box-sizing: border-box;
}
.prod-item img{ width:70%; height:auto; display:block; }

.prod-empty{ background:transparent; cursor:default; }

.cell[data-type="gold"]{ background: rgba(255,235,180,0.88); }
.cell[data-type="diamond"]{  background: rgba(200,235,255,0.88); }

.legend{ display:flex; gap:18px; justify-content:center; align-items:center; color:#cfcfcf; font-size:14px; margin-top:6px;}
.legend .box{ width:30px; height:30px; border-radius:6px; display:flex; align-items:center; justify-content:center; border:2px solid; }
.box.gold{ border-color:gold; } .box.diamond{ border-color:deepskyblue; }
.box img{ width:72%; height:auto; display:block; }
.hint{ font-size:12px; color:#aaa; text-align:center; margin-top:8px; }

.about-section {
  margin-top: 18px;
  text-align: center;
  font-size: 13px;
}
.about-title {
  color:#4cc9ff;
  cursor:pointer;
  font-weight:bold;
  margin-top:12px;
  text-decoration: underline;
}
.about-content {
  display:none;
  margin-top:6px;
  color:#ccc;
  line-height:1.6;
  font-size:13px;
}

@media (max-width:420px){
  :root{ --cell-size:40px; --prod-size:52px; --block-gap:8px; }
  .viewport{ padding: 0 4vw; }
}
@media (max-width:360px){
  :root{ --cell-size:36px; --prod-size:48px; --block-gap:6px; }
}
</style>
</head>
<body>
<div class="viewport">
  <div class="topbar">
    <input id="username" type="text" placeholder="Enter user name (optional)">
    <button id="sendBtn" class="btn">SEND</button>
    <button id="resetBtn" class="btn secondary">All Reset</button>
  </div>

  <div class="blocks" id="blocksContainer"></div>

  <div class="products">
    <div class="price-frame gold-frame" id="goldFrame"></div>
    <div class="price-frame dia-frame" id="diaFrame"></div>
  </div>

  <div class="legend">
    <div style="display:flex;align-items:center;gap:8px">
      <div class="box gold"><img src="https://raw.githubusercontent.com/MenboLD/LD_Field/main/icon_00_type_gold.png" alt="gold"></div>
      <div>… Gold</div>
    </div>
    <div style="display:flex;align-items:center;gap:8px">
      <div class="box diamond"><img src="https://raw.githubusercontent.com/MenboLD/LD_Field/main/icon_00_type_dia.png" alt="diamond"></div>
      <div>… Diamond</div>
    </div>
  </div>

  <div class="hint">
    Select below → place into the highlighted cell above.<br>
    When you enter your username, you can later view only your data in the aggregate results.<br>
    <a href="https://menbold.github.io/LD_Field/aggregate.html" target="_blank" style="color:#4cc9ff;text-decoration:none;font-weight:bold;">View aggregate results</a>
  </div>

  <div class="about-section">
    <div class="about-title" id="aboutToggle">About this page ▼</div>
    <div class="about-content" id="aboutContent">
      Because the appearance rates of resources in the Daily Shop are unknown, this page allows you to input and submit your actual shop lineups so we can analyze and display them collectively.<br>
      If you already know the internal logic or appearance patterns, please contact me at <b>menbo.luckyd@gmail.com</b>.<br><br>
      By entering your username, you can also use this page to keep a personal record of your submissions.<br>
      Ultimately, I hope to use this data to estimate how quickly new players can grow in strength based on their play frequency.
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* toggle about section */
document.addEventListener('DOMContentLoaded',()=>{
  const toggle=document.getElementById('aboutToggle');
  const content=document.getElementById('aboutContent');
  toggle.addEventListener('click',()=>{
    const visible=content.style.display==='block';
    content.style.display=visible?'none':'block';
    toggle.textContent=visible?'About this page ▼':'About this page ▲';
  });
});

/* prevent double-tap zoom */
document.addEventListener('touchend', (e) => {
  const now = Date.now();
  if (document.lastTouch && now - document.lastTouch < 300) e.preventDefault();
  document.lastTouch = now;
}, false);

/* blocks initialization */
const blocks = ['A','B','C','D','E','F'];
const slots = {};
const history = {};
const nextIndex = {};
let currentBlock = 'A';

blocks.forEach(b=>{
  slots[b] = [null,null,null,null,null,null,null];
  history[b] = [];
  nextIndex[b] = 2;
});

/* create block elements */
const blockContainer = document.getElementById('blocksContainer');
blocks.forEach(b=>{
  const block = document.createElement('div');
  block.className = 'block';
  block.dataset.block = b;
  block.innerHTML = `<div class="label">${b}</div>
    <div class="cell undo-cell" data-pos="1" data-block="${b}" title="UNDO" onclick="undoBlock('${b}')">
      <img src="https://raw.githubusercontent.com/MenboLD/LD_Field/main/icon_UNDO.png" alt="undo">
    </div>` + Array.from({length:5},(_,i)=>`<div class="cell" data-pos="${i+2}" data-block="${b}" onclick="focusCell(event)"></div>`).join('');
  blockContainer.appendChild(block);
});

/* define gold/diamond products */
const items=[
  "icon_01_unit.png","icon_02_free.png","icon_03_artifacts.png",
  "icon_03_scroll_30.png","icon_04_scroll_100.png","icon_05_scroll_300.png",
  "icon_06_Mythstone.png","icon_07_chur.png","icon_08_pet_draw.png","icon_09_pet_upgrade.png"
];

function buildProducts(frameId,type){
  const frame=document.getElementById(frameId);
  items.forEach((it,i)=>{
    if(type==='gold' && i>=6) return; // gold only first 6 items
    const div=document.createElement('div');
    div.className='prod-item';
    div.dataset.src=`https://raw.githubusercontent.com/MenboLD/LD_Field/main/${it}`;
    div.dataset.type=type;
    div.onclick=placeProduct;
    div.innerHTML=`<img src="https://raw.githubusercontent.com/MenboLD/LD_Field/main/${it}" alt="">`;
    frame.appendChild(div);
  });
}

buildProducts('goldFrame','gold');
buildProducts('diaFrame','diamond');

/* helper functions */
function cellEl(block,pos){ return document.querySelector(`.cell[data-block="${block}"][data-pos="${pos}"]`); }
function getNextBlock(block){ const i=blocks.indexOf(block); return blocks[(i+1)%blocks.length]; }
function refreshEditingHighlight(block){
  document.querySelectorAll('.cell').forEach(c=>c.classList.remove('editing'));
  const idx=nextIndex[block];
  if(idx>=2&&idx<=6){ const el=cellEl(block,idx); if(el) el.classList.add('editing'); }
  currentBlock=block;
}

function focusCell(e){
  const el=e.currentTarget; const b=el.dataset.block; const pos=+el.dataset.pos;
  if(pos>=2&&pos<=6) nextIndex[b]=pos; 
  refreshEditingHighlight(b);
}

function placeProduct(e){
  const item=e.currentTarget;
  const src=item.dataset.src; const type=item.dataset.type;
  const b=currentBlock; const idx=nextIndex[b]; if(!(idx>=2&&idx<=6))return;
  slots[b][idx]={src,type}; history[b].push(idx);
  const t=cellEl(b,idx); if(t){t.innerHTML=`<img src="${src}" alt="">`;t.setAttribute('data-type',type);}
  // move to next empty slot
  let ni=idx+1; while(ni<=6&&slots[b][ni])ni++;
  if(ni<=6){nextIndex[b]=ni;refreshEditingHighlight(b);}
  else{nextIndex[getNextBlock(b)]=2;refreshEditingHighlight(getNextBlock(b));}
}

function undoBlock(b){
  const last=history[b].pop(); if(!last)return;
  slots[b][last]=null; const t=cellEl(b,last); if(t){t.innerHTML='';t.removeAttribute('data-type');}
  nextIndex[b]=last; refreshEditingHighlight(b);
}

/* reset all blocks */
document.getElementById('resetBtn').addEventListener('click',()=>{
  blocks.forEach(b=>{
    history[b]=[];
    for(let i=2;i<=6;i++){
      slots[b][i]=null; 
      const t=cellEl(b,i); if(t){t.innerHTML='';t.removeAttribute('data-type');} 
    }
    nextIndex[b]=2;
  });
  currentBlock='A'; refreshEditingHighlight('A');
});

/* send animation + auto reset */
document.getElementById('sendBtn').addEventListener('click',async ()=>{
  const btn=document.getElementById('sendBtn');
  btn.animate([{transform:'scale(1)'},{transform:'scale(0.95)'},{transform:'scale(1)'}],{duration:180});
  await sendDataToSupabase();
  document.getElementById('resetBtn').click();
});

/* highlight first cell */
document.addEventListener('DOMContentLoaded',()=>{currentBlock='A';nextIndex['A']=2;refreshEditingHighlight('A');});

/* Supabase setup */
const SUPABASE_URL="https://cxgbloauhimuhdjlvwvh.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN4Z2Jsb2F1aGltdWhkamx2d3ZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4NDQ1MDIsImV4cCI6MjA3NjQyMDUwMn0.wnRHKccWAba4wzC1XHqYPdzL0wF5uQOImbLkn4rs6SA";
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

/* mapping for sending to DB */
const ITEM_NAME_MAP = {
  "icon_01_unit": "Unit",
  "icon_02_free": "Free",
  "icon_03_artifacts": "Artifact",
  "icon_03_scroll_30": "Scroll_30",
  "icon_04_scroll_100": "Scroll_100",
  "icon_05_scroll_300": "Scroll_300",
  "icon_06_Mythstone": "Mythstone",
  "icon_07_chur": "Chur",
  "icon_08_pet_draw": "PetDraw",
  "icon_09_pet_upgrade": "PetUpgrade"
};

async function sendDataToSupabase(){
  const name=document.getElementById('username').value.trim()||"NoneName";
  const payload={username:name};

  blocks.forEach(b=>{
    const block={};
    for(let i=2;i<=6;i++){
      const s=slots[b][i];
      if(s){
        const fileKey = s.src.split("/").pop().replace(".png","");
        const nameKey = ITEM_NAME_MAP[fileKey] || fileKey;
        block[i-1] = {src: nameKey, type: s.type};
      } else {
        block[i-1] = "NoneItem";
      }
    }
    payload[`block_${b.toLowerCase()}`] = block;
  });

  const {error} = await supabase.from("logs").insert([payload]);
  if(error) alert("Error: "+error.message);
  else alert("Upload completed!");
}
</script>
</body>
</html>
