<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>LD_DailyShop</title>
<style>
:root{
  --bg:#0f1113;
  --panel:#131417;
  --muted:#7a7f86;
  --accent:#ff4b4b;
  --cell-size:44px;
  --prod-size:56px;
  --block-gap:10px;
  --grid-gap:6px;
  --max-content-w:450px;
}
html,body{height:100%;margin:0;}
body{
  font-family:"Hiragino Kaku Gothic ProN","Segoe UI",Roboto,sans-serif;
  background:var(--bg);
  color:#fff;
  display:flex;
  justify-content:center;
  padding:18px 0;
}
.viewport{
  width: min(92vw, var(--max-content-w));
  margin: 0 auto;
  box-sizing: border-box;
  padding: 0 4vw;
}
.topbar { display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap; }
.topbar input {
  width:100%;
  padding:8px;
  border-radius:8px;
  border:1px solid #ccc;
  text-align:center;
}
.btn { flex:1; background: linear-gradient(180deg,#ffce00,#d4a000); border-radius:10px; padding:10px; font-weight:700; color:#111; border:0; box-shadow:0 4px #b38a00; cursor:pointer; transition: transform .08s, box-shadow .08s; }
.btn:active { transform: translateY(3px); box-shadow:0 2px #b38a00; }
.btn.secondary { background: linear-gradient(180deg,#00b4ff,#0072d4); color:#fff; box-shadow:0 4px #005ea8; }

/* blocks */
.blocks { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--block-gap); margin-bottom:12px; align-items: start; }
.block {
  background:var(--panel);
  padding:8px;
  border-radius:10px;
  position:relative;
  display:grid;
  grid-template-columns: repeat(3, var(--cell-size));
  grid-template-rows: repeat(2, var(--cell-size));
  gap: var(--grid-gap);
  justify-content:center;
}
.block .label { position:absolute; top:6px; left:8px; font-size:12px; color:var(--muted); }

.cell {
  width:var(--cell-size);
  height:var(--cell-size);
  border-radius:6px;
  background:#222;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  overflow:hidden;
  box-sizing:border-box;
  transition: box-shadow .08s, outline .08s, background .08s;
}
.cell img{ max-width:100%; max-height:100%; display:block; pointer-events:none; }

.cell.editing {
  outline: 3px solid var(--accent);
  outline-offset: -3px;
  background: #222;
}

.undo-cell { background:transparent; cursor:pointer; padding:2px; }
.undo-cell img{ width:100%; height:100%; object-fit:contain; }

.products { display:flex; flex-direction:column; gap:10px; margin-bottom:12px; }
.price-frame { border-radius:10px; padding:8px; display: grid; grid-template-columns: repeat(6, 1fr); gap:8px; align-items:center; width:100%; box-sizing:border-box; overflow:visible; }
.gold-frame { border:2px solid gold; background: rgba(255,215,0,0.06); padding:8px; }
.dia-frame  { border:2px solid deepskyblue; background: rgba(0,191,255,0.06); padding:8px; }

.prod-item {
  width: 100%;
  aspect-ratio: 1 / 1;
  border-radius:8px;
  background:#1b1d20;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  transition: transform .06s;
  box-sizing: border-box;
}
.prod-item img{ width:70%; height:auto; display:block; }

.prod-empty{ background:transparent; cursor:default; }

.cell[data-type="gold"]{ background: rgba(255,235,180,0.88); }
.cell[data-type="diamond"]{  background: rgba(200,235,255,0.88); }

.legend{ display:flex; gap:18px; justify-content:center; align-items:center; color:#cfcfcf; font-size:14px; margin-top:6px;}
.legend .box{ width:30px; height:30px; border-radius:6px; display:flex; align-items:center; justify-content:center; border:2px solid; }
.box.gold{ border-color:gold; } .box.diamond{ border-color:deepskyblue; }
.box img{ width:72%; height:auto; display:block; }
.hint{ font-size:12px; color:#aaa; text-align:center; margin-top:8px; }

.about-section {
  margin-top: 18px;
  text-align: center;
  font-size: 13px;
}
.about-title {
  color:#4cc9ff;
  cursor:pointer;
  font-weight:bold;
  margin-top:12px;
  text-decoration: underline;
}
.about-content {
  display:none;
  margin-top:6px;
  color:#ccc;
  line-height:1.6;
  font-size:13px;
}

@media (max-width:420px){
  :root{ --cell-size:40px; --prod-size:52px; --block-gap:8px; }
  .viewport{ padding: 0 4vw; }
}
@media (max-width:360px){
  :root{ --cell-size:36px; --prod-size:48px; --block-gap:6px; }
}
</style>
</head>
<body>
<div class="viewport">
  <div class="topbar">
    <input id="username" type="text" placeholder="Enter user name (optional)">
    <button id="sendBtn" class="btn">SEND</button>
    <button id="resetBtn" class="btn secondary">All Reset</button>
  </div>

  <div class="blocks" id="blocksContainer"></div>

  <div class="products">
    <div class="price-frame gold-frame" id="goldFrame"></div>
    <div class="price-frame dia-frame" id="diaFrame"></div>
  </div>

  <div class="legend">
    <div style="display:flex;align-items:center;gap:8px">
      <div class="box gold"><img src="https://raw.githubusercontent.com/MenboLD/LD_Field/main/icon_00_type_gold.png" alt="gold"></div>
      <div>… Gold</div>
    </div>
    <div style="display:flex;align-items:center;gap:8px">
      <div class="box diamond"><img src="https://raw.githubusercontent.com/MenboLD/LD_Field/main/icon_00_type_dia.png" alt="diamond"></div>
      <div>… Diamond</div>
    </div>
  </div>

  <div class="hint">
    Select below → place into the highlighted cell above.<br>
    When you enter your username, you can later view only your data in the aggregate results.<br>
    <a href="https://menbold.github.io/LD_Field/aggregate.html" target="_blank" style="color:#4cc9ff;text-decoration:none;font-weight:bold;">View aggregate results</a>
  </div>

  <div class="about-section">
    <div class="about-title" id="aboutToggle">About this page ▼</div>
    <div class="about-content" id="aboutContent">
      Because the appearance rates of resources in the Daily Shop are unknown, this page allows you to input and submit your actual shop lineups so we can analyze and display them collectively.<br>
      If you already know the internal logic or appearance patterns, please contact me at <b>menbo.luckyd@gmail.com</b>.<br><br>
      By entering your username, you can also use this page to keep a personal record of your submissions.<br>
      Ultimately, I hope to use this data to estimate how quickly new players can grow in strength based on their play frequency.
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
document.addEventListener('DOMContentLoaded',()=>{
  const toggle=document.getElementById('aboutToggle');
  const content=document.getElementById('aboutContent');
  toggle.addEventListener('click',()=>{
    const visible=content.style.display==='block';
    content.style.display=visible?'none':'block';
    toggle.textContent=visible?'About this page ▼':'About this page ▲';
  });
});

/* prevent double-tap zoom */
document.addEventListener('touchstart', function preventZoom(e) {
  if (e.touches.length > 1) e.preventDefault();
}, { passive: false });

/* Supabase setup */
const supabaseUrl = "https://cxgbloauhimuhdjlvwvh.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN4Z2Jsb2F1aGltdWhkamx2d3ZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4NDQ1MDIsImV4cCI6MjA3NjQyMDUwMn0.wnRHKccWAba4wzC1XHqYPdzL0wF5uQOImbLkn4rs6SA";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

/* items */
const ITEMS=[
  { key:"Unit", img:"https://raw.githubusercontent.com/MenboLD/LD_Field/main/icon_01_unit.png" },
  { key:"Key", img:"https://raw.githubusercontent.com/MenboLD/LD_Field/main/icon_02_free.png" },
  { key:"Artifact", img:"https://raw.githubusercontent.com/MenboLD/LD_Field/main/icon_03_artifacts.png" },
  { key:"Scroll_30", img:"https://raw.githubusercontent.com/MenboLD/LD_Field/main/icon_03_scroll_30.png" },
  { key:"Scroll_100", img:"https://raw.githubusercontent.com/MenboLD/LD_Field/main/icon_04_scroll_100.png" },
  { key:"Scroll_300", img:"https://raw.githubusercontent.com/MenboLD/LD_Field/main/icon_05_scroll_300.png" },
  { key:"Mythstone", img:"https://raw.githubusercontent.com/MenboLD/LD_Field/main/icon_06_Mythstone.png" },
  { key:"Chur", img:"https://raw.githubusercontent.com/MenboLD/LD_Field/main/icon_07_chur.png" },
  { key:"Battery", img:"https://raw.githubusercontent.com/MenboLD/LD_Field/main/icon_08_pet_draw.png" },
  { key:"Petfood", img:"https://raw.githubusercontent.com/MenboLD/LD_Field/main/icon_09_pet_upgrade.png" }
];

/* blocks & grid */
const blocksContainer=document.getElementById("blocksContainer");
const blockNames=['A','B','C','D','E','F'];
let activeCell=null;

function selectCell(cell){
  if(activeCell) activeCell.classList.remove('editing');
  activeCell=cell;
  cell.classList.add('editing');
}

/* fill a cell with item */
function fillCell(item,type){
  if(!activeCell) return;
  activeCell.innerHTML=`<img src="${item.img}" alt="${item.key}">`;
  activeCell.dataset.type=type;
  activeCell.dataset.src=item.key;
  activeCell.classList.remove('editing');
}

/* create blocks with optional existing data */
function createBlocks(existingData=null){
  blocksContainer.innerHTML='';

  blockNames.forEach((bname,bidx)=>{
    const block=document.createElement('div');
    block.className='block';

    const label=document.createElement('div');
    label.className='label';
    label.textContent=bname;
    block.appendChild(label);

    for(let i=0;i<6;i++){
      const cell=document.createElement('div');

      // 左上UNDOセル（Aブロックのみ）
      if(bidx===0 && i===0){
        cell.className='cell undo-cell';
        cell.innerHTML='<img src="https://raw.githubusercontent.com/MenboLD/LD_Field/main/icon_UNDO.png" alt="UNDO">';
        cell.addEventListener('click',()=>{
          if(activeCell){
            activeCell.innerHTML='';
            delete activeCell.dataset.src;
            delete activeCell.dataset.type;
          }
        });
      } else {
        cell.className='cell';
        cell.addEventListener('click',()=>selectCell(cell));

        // 既存データがあれば復元
        if(existingData && existingData[bname] && existingData[bname][i]){
          const slot = existingData[bname][i];
          if(slot.src!=='NoneItem'){
            const item=ITEMS.find(it=>it.key===slot.src);
            if(item){
              cell.innerHTML=`<img src="${item.img}" alt="${item.key}">`;
              cell.dataset.src=slot.src;
              cell.dataset.type=slot.type;
            }
          }
        }
      }

      cell.dataset.block=bname;
      cell.dataset.index=i;
      block.appendChild(cell);
    }

    blocksContainer.appendChild(block);
  });
}

/* products */
const goldFrame=document.getElementById('goldFrame');
const diaFrame=document.getElementById('diaFrame');

function createProducts(){
  ITEMS.forEach(it=>{
    const gbtn=document.createElement('div'); gbtn.className='prod-item'; gbtn.title=it.key+' (Gold)';
    gbtn.innerHTML=`<img src="${it.img}" alt="${it.key}">`;
    gbtn.addEventListener('click',()=>fillCell(it,'gold'));
    goldFrame.appendChild(gbtn);

    const dbtn=document.createElement('div'); dbtn.className='prod-item'; dbtn.title=it.key+' (Diamond)';
    dbtn.innerHTML=`<img src="${it.img}" alt="${it.key}">`;
    dbtn.addEventListener('click',()=>fillCell(it,'diamond'));
    diaFrame.appendChild(dbtn
