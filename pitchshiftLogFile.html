<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>LD Daily Shop — 編集モック (最終調整版)</title>
<style>
/* --- 省略：既存スタイルそのまま --- */
:root{
  --bg:#0f1113;
  --panel:#131417;
  --muted:#7a7f86;
  --accent:#ff4b4b;
  --cell-size:44px;
  --prod-size:56px;
  --block-gap:10px;
  --grid-gap:6px;
  --max-content-w:450px;
}
/* body, .viewport, .topbar, .btn, .blocks, .block, .cell, .products ... 既存スタイル保持 */
</style>
</head>
<body>
<div class="viewport">
  <div class="topbar">
    <div style="margin:10px 0; text-align:center;">
      <label for="username" style="font-weight:bold;">ユーザー名：</label>
      <input id="username" type="text" placeholder="（任意）名前を入力" style="padding:4px 8px; border-radius:6px; border:1px solid #ccc;">
    </div>
    <button id="sendBtn" class="btn">SEND</button>
    <button id="resetBtn" class="btn secondary">All Reset</button>
  </div>

  <div class="blocks" id="blocksContainer">
    <script>
      const blockNames = ['A','B','C','D','E','F'];
      blockNames.forEach(b=>{
        document.write(`
          <div class="block" data-block="${b}">
            <div class="label">${b}</div>
            <div class="cell undo-cell" data-pos="1" data-block="${b}" title="UNDO" onclick="undoBlock('${b}')">
              <img src="https://raw.githubusercontent.com/MenboLD/LD_Field/main/icon_UNDO.png?raw=true" alt="undo">
            </div>
            <div class="cell" data-pos="2" data-block="${b}" onclick="focusCell(event)"></div>
            <div class="cell" data-pos="3" data-block="${b}" onclick="focusCell(event)"></div>
            <div class="cell" data-pos="4" data-block="${b}" onclick="focusCell(event)"></div>
            <div class="cell" data-pos="5" data-block="${b}" onclick="focusCell(event)"></div>
            <div class="cell" data-pos="6" data-block="${b}" onclick="focusCell(event)"></div>
          </div>
        `);
      });
    </script>
  </div>

  <!-- 下段 Gold / Dia 商品群（省略: 既存コードそのまま） -->
  <div class="products">
    <!-- gold-frame, dia-frame 省略 -->
  </div>

  <!-- legend, hint 省略 -->
</div>

<script>
/* --- 状態 --- */
const blocks = ['A','B','C','D','E','F'];
const slots = {};
const history = {};
const nextIndex = {};
let currentBlock = 'A';

/* 初期化 */
blocks.forEach(b=>{
  slots[b] = [null,null,null,null,null,null,null];
  history[b] = [];
  nextIndex[b] = 2;
});

/* DOM helper */
function cellEl(block,pos){ return document.querySelector(`.cell[data-block="${block}"][data-pos="${pos}"]`); }
function getNextBlock(block){ const i = blocks.indexOf(block); return blocks[(i+1)%blocks.length]; }

function refreshEditingHighlight(block){
  document.querySelectorAll('.cell').forEach(c=>c.classList.remove('editing'));
  const idx = nextIndex[block];
  if(idx>=2 && idx<=6){
    const el = cellEl(block, idx);
    if(el) el.classList.add('editing');
  }
  currentBlock = block;
}

/* セル選択 */
function focusCell(e){
  const el = e.currentTarget;
  const block = el.dataset.block;
  const pos = Number(el.dataset.pos);
  if(pos>=2 && pos<=6) nextIndex[block] = pos;
  refreshEditingHighlight(block);
}

/* 配置 */
function placeProduct(e){
  const item = e.currentTarget;
  const src = item.dataset.src;
  const type = item.dataset.type || null;
  const block = currentBlock;
  const idx = nextIndex[block];
  if(!(idx>=2 && idx<=6)) return;

  slots[block][idx] = {src,type};
  history[block].push(idx);

  const target = cellEl(block,idx);
  if(target){
    target.innerHTML = `<img src="${src}" alt="">`;
    if(type) target.setAttribute('data-type',type); else target.removeAttribute('data-type');
  }

  // 次の入力位置
  let ni = idx+1;
  while(ni<=6 && slots[block][ni]) ni++;
  if(ni<=6){ nextIndex[block]=ni; refreshEditingHighlight(block); }
  else { nextIndex[getNextBlock(block)]=2; refreshEditingHighlight(getNextBlock(block)); }
}

/* UNDO */
function undoBlock(block){
  const last = history[block].pop();
  if(!last) return;
  slots[block][last] = null;
  const t = cellEl(block,last);
  if(t){ t.innerHTML=''; t.removeAttribute('data-type'); }
  nextIndex[block] = last;
  refreshEditingHighlight(block);
}

/* リセット（UNDO保持） */
document.getElementById('resetBtn').addEventListener('click',()=>{
  blocks.forEach(b=>{
    history[b] = [];
    for(let i=2;i<=6;i++){
      slots[b][i] = null;
      const t = cellEl(b,i);
      if(t){ t.innerHTML=''; t.removeAttribute('data-type'); }
    }
    nextIndex[b]=2;
  });
  currentBlock='A';
  refreshEditingHighlight('A');
});

/* SENDアニメ */
document.getElementById('sendBtn').addEventListener('click',()=>{
  const btn=document.getElementById('sendBtn');
  btn.animate([{transform:'scale(1)'},{transform:'scale(0.98)'},{transform:'scale(1)'}],{duration:180});
});

/* 初期選択 */
document.addEventListener('DOMContentLoaded',()=>{
  currentBlock='A';
  nextIndex['A']=2;
  refreshEditingHighlight('A');
});

/* --- sanitizeBlocks() 自動修正処理 --- */
function sanitizeBlocks(blocks){
  const sanitized = {};
  for(const [blockKey, blockArr] of Object.entries(blocks)){
    const items = blockArr.slice(2,7).map(v => v ? v.src : null).filter(Boolean);

    // 1〜4個 → 全消去
    if(items.length>0 && items.length<5){
      sanitized[blockKey] = Array(7).fill(null);
      continue;
    }

    // 重複チェック
    const count = {};
    items.forEach(src => count[src] = (count[src]||0)+1);
    const duplicates = Object.entries(count).filter(([_,c])=>c>=2);

    if(duplicates.some(([_,c])=>c>=3)){
      sanitized[blockKey] = Array(7).fill(null);
      continue;
    }

    if(duplicates.length===0){
      sanitized[blockKey] = blockArr.slice();
      continue;
    }

    // 重複2個 → _G / _D に分離
    const newBlock = blockArr.slice();
    duplicates.forEach(([src,_])=>{
      let cnt=0;
      for(let i=2;i<=6;i++){
        if(newBlock[i] && newBlock[i].src===src){
          cnt++;
          newBlock[i] = {...newBlock[i], src: src + (cnt===1 ? "_G":"_D")};
        }
      }
    });
    sanitized[blockKey] = newBlock;
  }
  return sanitized;
}

/* --- Supabase送信 --- */
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://あなたのプロジェクトURL.supabase.co";
const SUPABASE_KEY = "あなたのanonキー";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

function isBlank(str){ return (!str || /^\s*$/.test(str)); }

async function sendDataToSupabase(){
  let username = document.getElementById('username').value.trim();
  if(isBlank(username)) username = "NoneName";

  const sanitized = sanitizeBlocks(slots);

  function normalizeBlock(blockArr){
    const result = {};
    for(let i=1;i<=6;i++){
      const slot = blockArr[i];
      result[i] = (slot && slot.src) ? slot.src : "NoneItem";
    }
    return result;
  }

  if(Object.values(sanitized).every(b=>b.slice(2,7).every(v=>v===null))){
    alert("入力が不完全または無効なため送信できません。");
    return;
  }

  const payload = {
    username,
    block_a: normalizeBlock(sanitized['A']),
    block_b: normalizeBlock(sanitized['B']),
    block_c: normalizeBlock(sanitized['C']),
    block_d: normalizeBlock(sanitized['D']),
    block_e: normalizeBlock(sanitized['E']),
    block_f: normalizeBlock(sanitized['F']),
  };

  const { data, error } = await supabase.from('logs').insert([payload]);
  const btn = document.getElementById('sendBtn');
  btn.animate([{transform:'scale(1)'},{transform:'scale(0.98)'},{transform:'scale(1)'}], {duration:180});

  if(error) alert("送信エラー: "+error.message);
  else alert("送信完了しました！");
}

document.getElementById('sendBtn').addEventListener('click', async ()=>{ await sendDataToSupabase(); });
</script>

</body>
</html>
